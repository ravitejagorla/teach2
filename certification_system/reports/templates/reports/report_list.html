{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">

    <nav class="navbar navbar-expand-lg navbar-light bg-light rounded mb-4 p-3">
    <div class="container-fluid">

        <!-- Left side: Title -->
        <span class="navbar-brand mb-0 h4">Email Reports</span>

        <!-- Middle: Counts -->
        <div class="ms-3 d-flex align-items-center">
            <span class="me-3">Total: <span class="badge bg-primary">{{ total_count }}</span></span>
            <span class="me-3">Success: <span class="badge bg-success">{{ success_count }}</span></span>
            <span class="me-3">Failed: <span class="badge bg-danger">{{ failed_count }}</span></span>
        </div>

        <!-- Right side: Export button -->
        <div class="ms-auto">
            <a href="{% url 'report_export' %}" class="btn btn-success btn-sm">
                <i class="fas fa-download me-1"></i> Export
            </a>
        </div>

    </div>
</nav>


    <!-- Success Reports -->
    <h4 class="mt-4">Success Reports</h4>
    <div class="table-responsive">
        <table id="success-table" class="table table-striped table-hover table-bordered">
            <thead>
                <tr>
                    <th>Certificate ID</th>
                    <th>Student Name</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Sent At</th>
                    <th>Retry Count</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for report in success_reports %}
                <tr>
                    <td>{{ report.student.certificate_id }}</td>
                    <td>{{ report.student.full_name }}</td>
                    <td>{{ report.student.email }}</td>
                    <td><span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Success</span></td>
                    <td>{{ report.sent_at|date:"M d, Y H:i" }}</td>
                    <td>{{ report.retry_count }}</td>
                    <td class="text-nowrap">
                        <a href="{% url 'report_download' report.id %}" class="btn btn-sm btn-primary" title="Download">
                            <i class="fas fa-download"></i>
                        </a>
                        <a href="{% url 'report_resend' report.id %}" class="btn btn-sm btn-warning" title="Resend">
                            <i class="fas fa-rotate-right"></i>
                        </a>
                        <a href="{% url 'report_delete' report.id %}" class="btn btn-sm btn-danger" title="Delete"
                            onclick="return confirm('Are you sure you want to delete this report?');">
                            <i class="fas fa-trash"></i>
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center">No success reports.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Failed Reports -->
    <h4 class="mt-4">Failed Reports</h4>
    <div class="table-responsive">
        <table id="failed-table" class="table table-striped table-hover table-bordered">
            <thead>
                <tr>
                    <th>Certificate ID</th>
                    <th>Student Name</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Sent At</th>
                    <th>Error Message</th>
                    <th>Retry Count</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for report in failed_reports %}
                <tr>
                    <td>{{ report.student.certificate_id }}</td>
                    <td>{{ report.student.full_name }}</td>
                    <td>{{ report.student.email }}</td>
                    <td><span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i>Failed</span></td>
                    <td>{{ report.sent_at|date:"M d, Y H:i" }}</td>
                    <td>{{ report.error_message|default:"-" }}</td>
                    <td>{{ report.retry_count }}</td>
                    <td class="text-nowrap">
                        <a href="{% url 'report_download' report.id %}" class="btn btn-sm btn-primary" title="Download">
                            <i class="fas fa-download"></i>
                        </a>
                        <a href="{% url 'report_resend' report.id %}" class="btn btn-sm btn-warning" title="Resend">
                            <i class="fas fa-rotate-right"></i>
                        </a>
                        <a href="{% url 'report_delete' report.id %}" class="btn btn-sm btn-danger" title="Delete"
                            onclick="return confirm('Are you sure you want to delete this report?');">
                            <i class="fas fa-trash"></i>
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="text-center">No failed reports.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {
        $.fn.dataTable.ext.errMode = 'none';
        // Apply DataTables to both tables
        $('#success-table, #failed-table').DataTable({
            pageLength: 10,
            lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
            order: [[4, 'desc']], // Default order by Sent At column
            columnDefs: [
                { orderable: false, targets: -1 } // Disable sort for last column (Actions)
            ],
            responsive: true,
            autoWidth: false,
            language: {
                search: "üîç Search:",
                lengthMenu: "Show _MENU_ entries per page",
                zeroRecords: "No matching records found",
                info: "Showing _START_ to _END_ of _TOTAL_ entries",
                infoEmpty: "No records available",
                infoFiltered: "(filtered from _MAX_ total entries)"
            }
        });
    });
</script>
{% endblock %}