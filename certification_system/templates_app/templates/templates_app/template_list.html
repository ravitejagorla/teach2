{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Certificate Templates</h3>
        <button class="btn btn-primary" id="addTemplateBtn">
            <i class="fas fa-plus"></i> Add Template
        </button>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle" id="templatesTable">
            <thead class="table-light">
                <tr>
                    <th>Institution</th>
                    <th>Specialization</th>
                    <th>Organization</th>
                    <th>Course</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for template in templates %}
                <tr data-id="{{ template.id }}">
                    <td>{{ template.name }}</td>
                    <td>{{ template.specialization }}</td>
                    <td>{{ template.organization }}</td>
                    <td>{{ template.course }}</td>
                    <td>{{ template.get_template_type_display }}</td>
                    <td>
                        <span class="badge {% if template.is_active %}bg-success{% else %}bg-danger{% endif %}">
                            {{ template.is_active|yesno:"Active,Inactive" }}
                        </span>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-info viewTemplateBtn" data-id="{{ template.id }}" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-warning editTemplateBtn" data-id="{{ template.id }}" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger deleteTemplateBtn" data-id="{{ template.id }}" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center">No templates found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="templateModal" tabindex="-1" aria-labelledby="templateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" id="templateModalContent"></div>
    </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitle">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(function() {
    $('#templatesTable').DataTable({
        pageLength: 10,
        lengthMenu: [10, 25, 50, 100],
        order: [[0, "asc"]],
        columnDefs: [{ orderable: false, targets: -1 }]
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (const cookie of cookies) {
                const c = cookie.trim();
                if (c.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(c.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function showToast(type, message) {
        const toast = new bootstrap.Toast(document.getElementById('liveToast'));
        $('#toastTitle').text(type.charAt(0).toUpperCase() + type.slice(1));
        $('#toastMessage').text(message);
        toast.show();
    }

    function openModalWithForm(url, submitCallback) {
        $.ajax({
            url,
            headers: { "X-Requested-With": "XMLHttpRequest" },
            success: function(html) {
                $('#templateModalContent').html(html);
                const modal = new bootstrap.Modal(document.getElementById('templateModal'));
                modal.show();
                $('#templateForm').on('submit', function(e) {
                    e.preventDefault();
                    submitCallback(this, modal);
                });
            },
            error: function() {
                showToast('error', 'Failed to load form.');
            }
        });
    }

    $('#addTemplateBtn').on('click', function() {
        openModalWithForm("{% url 'templates_app:template_create' %}", function(form, modal) {
            const formData = new FormData(form);
            $.ajax({
                url: "{% url 'templates_app:template_create' %}",
                method: 'POST',
                headers: { "X-Requested-With": "XMLHttpRequest", "X-CSRFToken": csrftoken },
                data: formData,
                processData: false,
                contentType: false,
                success: function(data) {
                    if (data.status === 'success') {
                        showToast('success', data.message);
                        modal.hide();
                        setTimeout(() => location.reload(), 500);
                    } else {
                        showToast('error', 'Failed: ' + JSON.stringify(data.errors));
                    }
                }
            });
        });
    });

    $(document).on('click', '.editTemplateBtn', function() {
        const id = $(this).data('id');
        openModalWithForm("{% url 'templates_app:template_update' 0 %}".replace('0', id), function(form, modal) {
            const formData = new FormData(form);
            $.ajax({
                url: "{% url 'templates_app:template_update' 0 %}".replace('0', id),
                method: 'POST',
                headers: { "X-Requested-With": "XMLHttpRequest", "X-CSRFToken": csrftoken },
                data: formData,
                processData: false,
                contentType: false,
                success: function(data) {
                    if (data.status === 'success') {
                        showToast('success', data.message);
                        modal.hide();
                        setTimeout(() => location.reload(), 500);
                    } else {
                        showToast('error', 'Failed: ' + JSON.stringify(data.errors));
                    }
                }
            });
        });
    });

    $(document).on('click', '.viewTemplateBtn', function() {
        const id = $(this).data('id');
        $.ajax({
            url: "{% url 'templates_app:template_detail' 0 %}".replace('0', id),
            headers: { "X-Requested-With": "XMLHttpRequest" },
            success: function(html) {
                $('#templateModalContent').html(html);
                new bootstrap.Modal(document.getElementById('templateModal')).show();
            }
        });
    });

    $(document).on('click', '.deleteTemplateBtn', function() {
        if (!confirm("Are you sure you want to delete this template?")) return;
        const id = $(this).data('id');
        $.ajax({
            url: "{% url 'templates_app:template_delete' 0 %}".replace('0', id),
            method: 'POST',
            headers: { "X-Requested-With": "XMLHttpRequest", "X-CSRFToken": csrftoken },
            success: function(data) {
                showToast('success', data.message);
                setTimeout(() => location.reload(), 500);
            },
            error: function() {
                showToast('error', 'Failed to delete template.');
            }
        });
    });
});
</script>
{% endblock %}
