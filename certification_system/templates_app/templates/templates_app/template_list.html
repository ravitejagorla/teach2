{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Certificate Templates</h3>
        <button class="btn btn-primary" id="addTemplateBtn">
            <i class="fas fa-plus"></i> Add Template
        </button>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle" id="templatesTable">
            <thead class="table-light">
                <tr>
                    <th>Name</th>
                    <th>Specialization</th>
                    <th>Organization</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for template in templates %}
                <tr>
                    <td>{{ template.name }}</td>
                    <td>{{ template.specialization }}</td>
                    <td>{{ template.organization }}</td>
                    <td>{{ template.get_template_type_display }}</td>
                    <td>
                        {% if template.is_active %}
                            <span class="badge bg-success">Active</span>
                        {% else %}
                            <span class="badge bg-danger">Inactive</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info viewTemplateBtn" data-id="{{ template.id }}" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-warning editTemplateBtn" data-id="{{ template.id }}" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger deleteTemplateBtn" data-id="{{ template.id }}" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center">No templates found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="templateModal" tabindex="-1" aria-labelledby="templateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" id="templateModalContent"></div>
    </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitle">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize DataTable
    $('#templatesTable').DataTable({
        "pageLength": 10,
        "lengthMenu": [10, 25, 50, 100],
        "order": [[0, "asc"]]
    });

    // Get CSRF token from cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function showToast(type, message) {
        const toast = new bootstrap.Toast(document.getElementById('liveToast'));
        document.getElementById('toastTitle').textContent = type.charAt(0).toUpperCase() + type.slice(1);
        document.getElementById('toastMessage').textContent = message;
        toast.show();
    }

    // Add Template
    $('#addTemplateBtn').on('click', function() {
        $.ajax({
            url: "{% url 'templates_app:template_create' %}",
            headers: { "X-Requested-With": "XMLHttpRequest" },
            success: function(html) {
                $('#templateModalContent').html(html);
                const modal = new bootstrap.Modal(document.getElementById('templateModal'));
                modal.show();

                $('#templateForm').on('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    $.ajax({
                        url: "{% url 'templates_app:template_create' %}",
                        method: 'POST',
                        headers: {
                            "X-Requested-With": "XMLHttpRequest",
                            "X-CSRFToken": csrftoken
                        },
                        data: formData,
                        processData: false,
                        contentType: false,
                        dataType: 'json',
                        success: function(data) {
                            if (data.status === 'success') {
                                showToast('success', data.message);
                                modal.hide();
                                setTimeout(() => location.reload(), 800);
                            } else {
                                showToast('error', 'Failed to create template: ' + JSON.stringify(data.errors));
                            }
                        },
                        error: function(xhr, status, error) {
                            showToast('error', 'An error occurred: ' + error);
                        }
                    });
                });
            },
            error: function(xhr, status, error) {
                showToast('error', 'Failed to load form: ' + error);
            }
        });
    });

    // View Template
    $(document).on('click', '.viewTemplateBtn', function() {
        const id = $(this).data('id');
        $.ajax({
            url: "{% url 'templates_app:template_detail' 0 %}".replace('0', id),
            headers: { "X-Requested-With": "XMLHttpRequest" },
            success: function(html) {
                $('#templateModalContent').html(html);
                new bootstrap.Modal(document.getElementById('templateModal')).show();
            }
        });
    });

    // Edit Template
    $(document).on('click', '.editTemplateBtn', function() {
        const id = $(this).data('id');
        $.ajax({
            url: "{% url 'templates_app:template_update' 0 %}".replace('0', id),
            headers: { "X-Requested-With": "XMLHttpRequest" },
            success: function(html) {
                $('#templateModalContent').html(html);
                const modal = new bootstrap.Modal(document.getElementById('templateModal'));
                modal.show();

                $('#templateForm').on('submit', function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    $.ajax({
                        url: "{% url 'templates_app:template_update' 0 %}".replace('0', id),
                        method: 'POST',
                        headers: {
                            "X-Requested-With": "XMLHttpRequest",
                            "X-CSRFToken": csrftoken
                        },
                        data: formData,
                        processData: false,
                        contentType: false,
                        dataType: 'json',
                        success: function(data) {
                            if (data.status === 'success') {
                                showToast('success', data.message);
                                modal.hide();
                                setTimeout(() => location.reload(), 800);
                            } else {
                                showToast('error', 'Failed to update template: ' + JSON.stringify(data.errors));
                            }
                        }
                    });
                });
            }
        });
    });

    // Delete Template
    $(document).on('click', '.deleteTemplateBtn', function() {
        if (confirm("Are you sure you want to delete this template?")) {
            const id = $(this).data('id');
            $.ajax({
                url: "{% url 'templates_app:template_delete' 0 %}".replace('0', id),
                method: 'DELETE',
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": csrftoken
                },
                dataType: 'json',
                success: function(data) {
                    showToast('success', data.message);
                    setTimeout(() => location.reload(), 800);
                }
            });
        }
    });
});
</script>
{% endblock %}