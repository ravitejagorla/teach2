{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">Students</h1>
    <div>
        <a href="{% url 'student_create' %}" class="btn btn-primary btn-sm me-2">
            <i class="fas fa-plus me-1"></i> Add Student
        </a>
        <a href="{% url 'student_import' %}" class="btn btn-outline-secondary btn-sm me-2">
            <i class="fas fa-upload me-1"></i> Import
        </a>
        <a href="{% url 'student_export' %}" class="btn btn-outline-success btn-sm me-2">
            <i class="fas fa-download me-1"></i> Export
        </a>
        <button id="bulkDeleteBtn" class="btn btn-danger btn-sm me-2" disabled>
            <i class="fas fa-trash me-1"></i> Delete Selected
        </button>
        <button id="bulkSendBtn" class="btn btn-warning btn-sm" disabled>
            <i class="fas fa-paper-plane me-1"></i> Send Certificates
        </button>
    </div>
</div>

<div class="alert alert-info d-flex align-items-center" role="alert">
    <i class="fas fa-info-circle me-2"></i>
    <div>Select students using checkboxes and use bulk actions to delete or send certificates</div>
</div>

<div class="card">
    <div class="card-body p-2">
        <div class="table-responsive">
            <table id="students-table" class="table table-sm table-striped table-hover table-bordered" style="font-size: 0.85rem;">
                <thead class="table-light">
                    <tr>
                        <th width="40">
                            <input type="checkbox" id="selectAll">
                        </th>
                        <th width="40">S.No</th>
                        <th width="120">Cert ID</th>
                        <th>Full Name</th>
                        <th>Email</th>
                        <th width="100">Mobile</th>
                        <th>Specialization</th>
                        <th>Course</th>
                        <th>Organization</th>
                        <th width="150">Institution</th>
                        <th width="90">Start Date</th>
                        <th width="90">End Date</th>
                        <th width="120" class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr>
                        <td class="text-center">
                            <input type="checkbox" class="student-checkbox" value="{{ student.id }}">
                        </td>
                        <td class="text-center">{{ forloop.counter }}</td>
                        <td>{{ student.certificate_id }}</td>
                        <td>{{ student.full_name }}</td>
                        <td>{{ student.email }}</td>
                        <td>{{ student.mobile|default:"-" }}</td>
                        <td>{{ student.specialization }}</td>
                        <td>{{ student.course }}</td>
                        <td>{{ student.organization }}</td>
                        <td>{{ student.institution }}</td>
                        <td>{{ student.start_date|date:"d/m/y" }}</td>
                        <td>{{ student.end_date|date:"d/m/y" }}</td>
                        <td class="text-center">
                            <div class="btn-group" role="group">
                                <a href="{% url 'student_edit' student.pk %}" class="btn btn-sm btn-outline-primary" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger delete-btn" data-id="{{ student.pk }}" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% if student.template and student.template.is_active %}
                                <a href="{% url 'download_certificate' student.id %}" class="btn btn-sm btn-success" title="Download Certificate">
                                    <i class="fas fa-download"></i>
                                </a>
                                {% else %}
                                <button class="btn btn-sm btn-outline-secondary" title="No Template Available" disabled>
                                    <i class="fas fa-ban"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="13" class="text-center py-3">No students found. <a href="{% url 'student_create' %}">Add your first student</a></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Progress Modal for Sending Certificates -->
<div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sending Certificates</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div class="spinner-border text-success" role="status"></div>
                </div>
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                         role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="text-center"><span id="progress-text">Processing... 0%</span></div>
                <div id="status-messages" class="mt-3 small"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Progress Modal for Bulk Delete -->
<div class="modal fade" id="deleteProgressModal" tabindex="-1" aria-labelledby="deleteProgressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Deleting Students</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div class="spinner-border text-danger" role="status"></div>
                </div>
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-danger" 
                         role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="text-center"><span id="delete-progress-text">Processing... 0%</span></div>
                <div id="delete-status-messages" class="mt-3 small"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    const csrftoken = '{{ csrf_token }}';

    // DataTable init
    $('#students-table').DataTable({
        pageLength: 25,
        lengthMenu: [[10,25,50,100,-1],[10,25,50,100,"All"]],
        columnDefs: [
            { orderable: false, targets: [0,1,12] },
            { className: "dt-body-center", targets: [0,1,12] }
        ],
        responsive: true,
        autoWidth: false
    });

    // Bulk buttons update
    function updateBulkButtons() {
        const selectedCount = $('.student-checkbox:checked').length;
        $('#bulkDeleteBtn').prop('disabled', selectedCount === 0);
        $('#bulkSendBtn').prop('disabled', selectedCount === 0);
        $('#bulkDeleteBtn').html(selectedCount > 0 ? `<i class="fas fa-trash me-1"></i> Delete (${selectedCount})` : '<i class="fas fa-trash me-1"></i> Delete Selected');
        $('#bulkSendBtn').html(selectedCount > 0 ? `<i class="fas fa-paper-plane me-1"></i> Send (${selectedCount})` : '<i class="fas fa-paper-plane me-1"></i> Send Certificates');
    }

    $('#selectAll').click(function() {
        $('.student-checkbox').prop('checked', this.checked);
        updateBulkButtons();
    });
    $('.student-checkbox').change(updateBulkButtons);

    // Single delete
    $('.delete-btn').click(function() {
        const studentId = $(this).data('id');
        if (!confirm('Are you sure you want to delete this student?')) return;

        $.post(`/students/${studentId}/delete/`, {}, function(resp){
            if(resp.status === 'success') location.reload();
            else alert('Error deleting student.');
        });
    });

    // Bulk delete
    $('#bulkDeleteBtn').click(function() {
        const studentIds = $('.student-checkbox:checked').map(function(){ return $(this).val(); }).get();
        if(!studentIds.length || !confirm(`Delete ${studentIds.length} students?`)) return;

        const deleteModal = new bootstrap.Modal(document.getElementById('deleteProgressModal'));
        deleteModal.show();
        const progressBar = $('#deleteProgressModal .progress-bar');
        const progressText = $('#delete-progress-text');
        const statusMessages = $('#delete-status-messages');
        let processed = 0;
        statusMessages.empty();

        studentIds.forEach((id, index) => {
            setTimeout(() => {
                $.ajax({
                    url: "{% url 'bulk_delete_students' %}",
                    type: 'POST',
                    headers: { 'X-CSRFToken': csrftoken },
                    contentType: 'application/json',
                    data: JSON.stringify({ student_ids: [id] }),
                    success: function(resp){
                        processed++;
                        const perc = Math.round((processed/studentIds.length)*100);
                        progressBar.css('width', perc + '%').attr('aria-valuenow', perc);
                        progressText.text(`Deleting... ${perc}%`);
                        statusMessages.append(`<div class="text-success">Deleted student ID: ${id}</div>`);
                        if(processed === studentIds.length) setTimeout(()=>location.reload(),1000);
                    },
                    error: function(){ processed++; statusMessages.append(`<div class="text-danger">Failed student ID: ${id}</div>`); }
                });
            }, index*300);
        });
    });

    // Bulk send certificates
    $('#bulkSendBtn').click(function(){
        const studentIds = $('.student-checkbox:checked').map(function(){ return $(this).val(); }).get();
        if(!studentIds.length || !confirm(`Send certificates to ${studentIds.length} students?`)) return;

        const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
        progressModal.show();
        const progressBar = $('#progressModal .progress-bar');
        const progressText = $('#progress-text');
        const statusMessages = $('#status-messages');
        let processed = 0;
        statusMessages.empty();

        studentIds.forEach((id,index)=>{
            setTimeout(()=>{
                $.ajax({
                    url:`/students/${id}/send-certificate/`,
                    type:'POST',
                    headers:{'X-CSRFToken':csrftoken},
                    success:function(resp){
                        processed++;
                        const perc = Math.round((processed/studentIds.length)*100);
                        progressBar.css('width',perc+'%').attr('aria-valuenow',perc);
                        progressText.text(`Processing... ${perc}%`);
                        statusMessages.append(`<div class="text-success">Sent to ${resp.student_name}</div>`);
                    },
                    error:function(){
                        processed++;
                        statusMessages.append(`<div class="text-danger">Failed student ID: ${id}</div>`);
                    }
                });
            }, index*500);
        });
    });

});
</script>
{% endblock %}