{% extends 'base.html' %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-light bg-light m-3">
    <div class="container-fluid">
        <a class="navbar-brand h3 mb-0" href="#">Students</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#studentNavbar"
            aria-controls="studentNavbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="studentNavbar">
            <div class="navbar-nav ms-auto">
                <button id="copyBtn" class="btn btn-info btn-sm me-2 mb-1" onclick="copyRegistrationURL()">
                    <i class="fas fa-copy me-1"></i> Registration URL
                </button>
                <a href="{% url 'student_create' %}" class="btn btn-primary btn-sm me-2 mb-1">
                    <i class="fas fa-plus me-1"></i> Add Student
                </a>
                <!-- <button class="btn btn-primary btn-sm me-2 mb-1" data-bs-toggle="modal" data-bs-target="#createModal">
          <i class="fas fa-upload me-1"></i> Add Student
        </button> -->
                <button class="btn btn-outline-secondary btn-sm me-2 mb-1" data-bs-toggle="modal"
                    data-bs-target="#importModal">
                    <i class="fas fa-upload me-1"></i> Import
                </button>
                <a href="{% url 'student_export' %}" class="btn btn-outline-success btn-sm me-2 mb-1">
                    <i class="fas fa-download me-1"></i> Export
                </a>
                <button id="bulkDeleteBtn" class="btn btn-danger btn-sm me-2 mb-1" disabled>
                    <i class="fas fa-trash me-1"></i> Delete Selected
                </button>
                <button id="bulkSendBtn" class="btn btn-warning btn-sm mb-1" disabled>
                    <i class="fas fa-paper-plane me-1"></i> Send Certificates
                </button>
            </div>
        </div>
    </div>
</nav>

<!-- <div class="alert alert-info d-flex align-items-center" role="alert">
    <i class="fas fa-info-circle me-2"></i>
    <div>Select students using checkboxes and use bulk actions to delete or send certificates</div>
</div> -->

<div class="card">
    <div class="card-body p-2">
        <div class="table-responsive">
            <table id="students-table" class="table table-sm table-striped table-hover table-bordered"
                style="font-size: 0.85rem;">
                <thead class="table-light">
                    <tr>
                        <th width="40"><input type="checkbox" id="selectAll"></th>
                        <th width="40">S.No</th>
                        <th width="120">Cert ID</th>
                        <th>Full Name</th>
                        <th>Email</th>
                        <th width="100">Mobile</th>
                        <th>Specialization</th>
                        <th>Course</th>
                        <th>Organization</th>
                        <th width="150">Institution</th>
                        <th width="90">Start Date</th>
                        <th width="90">End Date</th>
                        <th width="200" class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr>
                        <td class="text-center">
                            <input type="checkbox" class="student-checkbox" value="{{ student.id }}">
                        </td>
                        <td class="text-center">{{ forloop.counter }}</td>
                        <td>{{ student.certificate_id }}</td>
                        <td>{{ student.full_name }}</td>
                        <td>{{ student.email }}</td>
                        <td>{{ student.mobile|default:"-" }}</td>
                        <td>{{ student.specialization }}</td>
                        <td>{{ student.course }}</td>
                        <td>{{ student.organization }}</td>
                        <td>{{ student.institution }}</td>
                        <td>{{ student.start_date|date:"d/m/y" }}</td>
                        <td>{{ student.end_date|date:"d/m/y" }}</td>
                        <td class="text-center">
                            <div class="btn-group" role="group">
                                <a href="{% url 'student_edit' student.pk %}" class="btn btn-sm btn-outline-primary"
                                    title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger delete-btn" data-id="{{ student.pk }}"
                                    title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>

                                {% if student.template and student.template.is_active %}
                                <!-- Download -->
                                <button class="btn btn-sm btn-success download-btn" data-student-id="{{ student.id }}"
                                    data-template-id="{{ student.template.id }}"
                                    title="Download Certificate or Template">
                                    <i class="fas fa-download"></i>
                                </button>
                                <!-- Send -->
                                <button class="btn btn-sm btn-warning send-btn" data-student-id="{{ student.id }}"
                                    data-template-id="{{ student.template.id }}" title="Send Certificate">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                                {% else %}
                                <button class="btn btn-sm btn-outline-secondary" title="No Template Available" disabled>
                                    <i class="fas fa-ban"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="13" class="text-center py-3">No students found. <a
                                href="{% url 'student_create' %}">Add your first student</a></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Progress Modal for Sending Certificates -->
<div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sending Certificates</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div class="spinner-border text-success" role="status"></div>
                </div>
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar"
                        style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="text-center"><span id="progress-text">Processing... 0%</span></div>
                <div id="status-messages" class="mt-3 small"></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary"
                    data-bs-dismiss="modal">Close</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="importForm" method="post" enctype="multipart/form-data" action="{% url 'student_import' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Import Students</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="csvFile" class="form-label">Choose CSV File</label>
                        <input type="file" class="form-control" id="csvFile" name="file" accept=".csv" required>
                    </div>
                    <div id="importStatus" class="mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Progress Modal for Bulk Delete -->
<div class="modal fade" id="deleteProgressModal" tabindex="-1" aria-labelledby="deleteProgressModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Deleting Students</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div class="spinner-border text-danger" role="status"></div>
                </div>
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-danger" role="progressbar"
                        style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="text-center"><span id="delete-progress-text">Processing... 0%</span></div>
                <div id="delete-status-messages" class="mt-3 small"></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary"
                    data-bs-dismiss="modal">Close</button></div>
        </div>
    </div>
</div>

<!-- Modal for Download Choice -->
<div class="modal fade" id="downloadChoiceModal" tabindex="-1" aria-labelledby="downloadChoiceModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Download Certificate</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p>Choose the type of download:</p>
                <button id="downloadGenerated" class="btn btn-success me-2">Generated Certificate PDF</button>
                <button id="downloadManual" class="btn btn-info">Manual Template</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Send Choice -->
<div class="modal fade" id="sendChoiceModal" tabindex="-1" aria-labelledby="sendChoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Send Certificate</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p>Choose the type of certificate to send:</p>
                <button id="sendGenerated" class="btn btn-success me-2">Generated Certificate</button>
                <button id="sendManual" class="btn btn-info">Manual Template</button>
            </div>
        </div>
    </div>
</div>



{% endblock %}

{% block extra_js %}
<script>
    function copyRegistrationURL() {
        const url = "http://127.0.0.1:8000/students/register/";
        navigator.clipboard.writeText(url)
            .then(() => {
                const btn = document.getElementById('copyBtn');
                // Add animation class
                btn.classList.add('copied');
                // Remove the class after animation ends
                setTimeout(() => btn.classList.remove('copied'), 500);
            })
            .catch(err => console.error('Failed to copy: ', err));
    }

    $(document).ready(function () {
        const csrftoken = '{{ csrf_token }}';
        $.fn.dataTable.ext.errMode = 'none';

        $('#students-table').DataTable({
            pageLength: 25,
            lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
            columnDefs: [
                { orderable: false, targets: [0, 1, 12] },
                { className: "dt-body-center", targets: [0, 1, 12] }
            ],
            responsive: true,
            autoWidth: false
        });

        function updateBulkButtons() {
            const selectedCount = $('.student-checkbox:checked').length;
            $('#bulkDeleteBtn').prop('disabled', selectedCount === 0)
                .html(selectedCount > 0 ? `<i class="fas fa-trash me-1"></i> Delete (${selectedCount})` : '<i class="fas fa-trash me-1"></i> Delete Selected');
            $('#bulkSendBtn').prop('disabled', selectedCount === 0)
                .html(selectedCount > 0 ? `<i class="fas fa-paper-plane me-1"></i> Send (${selectedCount})` : '<i class="fas fa-paper-plane me-1"></i> Send Certificates');
        }

        $('#selectAll').click(function () {
            $('.student-checkbox').prop('checked', this.checked);
            updateBulkButtons();
        });
        $('.student-checkbox').change(updateBulkButtons);

        $('.delete-btn').click(function () {
            const studentId = $(this).data('id');
            $.post(`/students/${studentId}/delete/`, {}, function (resp) {
                if (resp.status === 'success') location.reload();

            });
        });

        function processBulkAction(studentIds, ajaxUrl, progressModalId, progressBarClass, progressTextId, statusMessagesId, successMessage, reloadOnFinish = false) {
            const modal = new bootstrap.Modal(document.getElementById(progressModalId));
            modal.show();
            const progressBar = $(`#${progressModalId} ${progressBarClass}`);
            const progressText = $(`#${progressModalId} ${progressTextId}`);
            const statusMessages = $(`#${progressModalId} ${statusMessagesId}`);
            let processed = 0;
            statusMessages.empty();
            studentIds.forEach((id, index) => {
                setTimeout(() => {
                    $.ajax({
                        url: ajaxUrl.replace('STUDENT_ID', id),
                        type: 'POST',
                        headers: { 'X-CSRFToken': csrftoken },
                        success: function (resp) {
                            processed++;
                            const perc = Math.round((processed / studentIds.length) * 100);
                            progressBar.css('width', perc + '%').attr('aria-valuenow', perc);
                            progressText.text(`Processing... ${perc}%`);
                            statusMessages.append(`<div class="text-success">${successMessage.replace('STUDENT_NAME', resp?.student_name || '')}</div>`);
                            if (processed === studentIds.length) {
                                setTimeout(() => { modal.hide(); if (reloadOnFinish) location.reload(); }, 1000);
                            }
                        },
                        error: function () {
                            processed++;
                            statusMessages.append(`<div class="text-danger">Failed student ID: ${id}</div>`);
                            if (processed === studentIds.length) {
                                setTimeout(() => { modal.hide(); }, 1000);
                            }
                        }
                    });
                }, index * 300);
            });
        }
        // --------------------------
        // Import via AJAX
        // --------------------------
        $('#importForm').submit(function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            $('#importStatus').html('<div class="spinner-border spinner-border-sm me-2"></div>Uploading...');
            $.ajax({
                url: $(this).attr('action'),
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (resp) { location.reload(); },
                error: function (xhr) { $('#importStatus').html(`<div class="alert alert-danger">Error: ${xhr.responseText}</div>`); }
            });
        });
        $('#bulkDeleteBtn').click(function () {
            const studentIds = $('.student-checkbox:checked').map(function () { return $(this).val(); }).get();


            const modal = new bootstrap.Modal(document.getElementById('deleteProgressModal'));
            modal.show();
            const progressBar = $('#deleteProgressModal .progress-bar');
            const progressText = $('#delete-progress-text');
            const statusMessages = $('#delete-status-messages');

            $.ajax({
                url: "{% url 'bulk_delete_students' %}",
                type: "POST",
                headers: { "X-CSRFToken": csrftoken },
                contentType: "application/json",
                data: JSON.stringify({ student_ids: studentIds }),
                success: function (resp) {
                    if (resp.status === "success") {
                        progressBar.css("width", "100%").attr("aria-valuenow", 100);
                        progressText.text("Processing... 100%");
                        statusMessages.append(`<div class="text-success">${resp.message}</div>`);
                        setTimeout(() => { modal.hide(); location.reload(); }, 1000);
                    } else {
                        statusMessages.append(`<div class="text-danger">${resp.message}</div>`);
                    }
                },
                error: function (xhr) {
                    statusMessages.append(`<div class="text-danger">Error: ${xhr.responseText}</div>`);
                }
            });
        });


        // --- Download Choice ---
        let selectedStudentId = null;
        $(document).on('click', '.download-btn', function () {
            selectedStudentId = $(this).data('student-id');
            new bootstrap.Modal(document.getElementById('downloadChoiceModal')).show();
        });
        $('#downloadGenerated').click(function () {
            window.location.href = "{% url 'download_certificate' 0 %}".replace('0', selectedStudentId) + '?type=auto';
            selectedStudentId = null;
            bootstrap.Modal.getInstance(document.getElementById('downloadChoiceModal')).hide();
        });
        $('#downloadManual').click(function () {
            const templateId = $(`.download-btn[data-student-id="${selectedStudentId}"]`).data('template-id');
            if (!templateId) { return; }
            window.location.href = "{% url 'mt' 0 %}".replace('0', selectedStudentId) + '?type=manual';
            selectedStudentId = null;
            bootstrap.Modal.getInstance(document.getElementById('downloadChoiceModal')).hide();
        });

        // --- Send Choice (Single + Bulk) ---
        let sendStudentIds = [];
        let isBulkSend = false;
        $(document).on('click', '.send-btn', function () {
            sendStudentIds = [$(this).data('student-id')];
            isBulkSend = false;
            new bootstrap.Modal(document.getElementById('sendChoiceModal')).show();
        });
        $('#bulkSendBtn').click(function () {
            sendStudentIds = $('.student-checkbox:checked').map(function () { return $(this).val(); }).get();
            if (!sendStudentIds.length) return;
            isBulkSend = true;
            new bootstrap.Modal(document.getElementById('sendChoiceModal')).show();
        });

        $('#sendGenerated').click(function () {
            if (!sendStudentIds.length) return;
            if (isBulkSend) {
                processBulkAction(sendStudentIds, "/students/STUDENT_ID/send-certificate/?type=auto", 'progressModal',
                    '.progress-bar', '#progress-text', '#status-messages', 'Sent Generated Certificate to STUDENT_NAME');
            } else {
                $.post(`/students/${sendStudentIds[0]}/send-certificate/?type=auto`, {}, function (resp) {

                });
            }
            bootstrap.Modal.getInstance(document.getElementById('sendChoiceModal')).hide();
            sendStudentIds = [];
        });
        $('#sendManual').click(function () {
            if (!sendStudentIds.length) return;
            if (isBulkSend) {
                processBulkAction(sendStudentIds, "/students/STUDENT_ID/send-certificate/?type=manual", 'progressModal',
                    '.progress-bar', '#progress-text', '#status-messages', 'Sent Manual Template to STUDENT_NAME');
            } else {
                $.post(`/students/${sendStudentIds[0]}/send-certificate/?type=manual`, {}, function (resp) {

                });
            }
            bootstrap.Modal.getInstance(document.getElementById('sendChoiceModal')).hide();
            sendStudentIds = [];
        });
    });
</script>
{% endblock %}